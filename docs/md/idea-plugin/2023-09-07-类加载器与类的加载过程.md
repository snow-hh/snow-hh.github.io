# ç¬¬5èŠ‚ï¼šJVMçš„æ¶æ„æ¨¡å‹

ä½œè€…ï¼šå°èƒ¡

>æ²‰æ·€ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## ä¸€ã€ç±»åŠ è½½å™¨å­ç³»ç»Ÿ

![](https://snow-hh.github.io/assets/img/jvm/5-01.png)

- ç±»åŠ è½½å™¨å­ç³»ç»Ÿè´Ÿè´£ä»æ–‡ä»¶ç³»ç»Ÿæˆ–è€…ç½‘ç»œä¸­åŠ è½½Classæ–‡ä»¶ï¼Œclassæ–‡ä»¶åœ¨æ–‡ä»¶å¼€å¤´æœ‰ç‰¹å®šçš„æ–‡ä»¶æ ‡è¯†ã€‚ï¼ˆCOFEBABEï¼‰
- ClassLoaderåªè´Ÿè´£classæ–‡ä»¶çš„åŠ è½½ï¼Œè‡³äºå®ƒæ˜¯å¦å¯ä»¥è¿è¡Œï¼Œåˆ™ç”±ExecutionEngineï¼ˆæ‰§è¡Œå¼•æ“ï¼‰å†³å®šã€‚
- åŠ è½½çš„ç±»ä¿¡æ¯å­˜æ”¾äºä¸€å—ç§°ä¸ºæ–¹æ³•åŒºçš„å†…å­˜ç©ºé—´ã€‚é™¤äº†ç±»çš„ä¿¡æ¯å¤–ï¼Œæ–¹æ³•åŒºä¸­è¿˜ä¼šå­˜æ”¾è¿è¡Œæ—¶å¸¸é‡ä¿¡æ¯ï¼Œè¿˜å¯èƒ½åŒ…å«å­—ç¬¦ä¸²å­—é¢é‡å’Œæ•°å­—å¸¸é‡ï¼ˆè¿™éƒ¨åˆ†å¸¸é‡ä¿¡æ¯æ˜¯Classæ–‡ä»¶ä¸­å¸¸é‡æ± éƒ¨åˆ†çš„å†…å­˜æ˜ å°„

## äºŒã€ç±»åŠ è½½å™¨ClassLoaderçš„è§’è‰²

![](https://snow-hh.github.io/assets/img/jvm/5-02.png)

-  class  file å­˜æ”¾äºæœ¬åœ°ç£ç›˜ä¸Šï¼Œå¯ä»¥ç†è§£ä¸ºè®¾è®¡å¸ˆç”»åœ¨çº¸ä¸Šçš„æ¨¡æ¿ï¼Œè€Œæœ€ç»ˆè¿™ä¸ªæ¨¡æ¿åœ¨æ‰§è¡Œçš„æ—¶å€™æ˜¯è¦åŠ è½½åˆ°JVMå½“ä¸­æ¥æ ¹æ®è¿™ä¸ªæ–‡ä»¶å®ä¾‹åŒ–å‡ºnä¸ªä¸€æ¨¡ä¸€æ ·çš„å®ä¾‹ã€‚
-  class  file åŠ è½½åˆ°JVMä¸­ï¼Œè¢«ç§°ä¸ºDNAå…ƒæ•°æ®æ¨¡æ¿ï¼Œæ”¾åœ¨æ–¹æ³•åŒºã€‚
-  åœ¨.classæ–‡ä»¶->JVM ->æœ€ç»ˆæˆä¸ºå…ƒæ•°æ®æ¨¡æ¿ï¼Œæ­¤è¿‡ç¨‹å°±è¦ä¸€ä¸ªè¿è¾“å·¥å…·ï¼ˆç±»åŠ è½½å™¨Class Loaderï¼‰æ‰®æ¼”ä¸€ä¸ªå¿«é€’å‘˜çš„è§’è‰²ã€‚

## ä¸‰ã€ç±»çš„åŠ è½½è¿‡ç¨‹

![](https://snow-hh.github.io/assets/img/jvm/5-03.png)

![](https://snow-hh.github.io/assets/img/jvm/5-04.png)

### 1ã€åŠ è½½ï¼ˆLoadingï¼‰
- é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåè·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶æµ
- å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬æ¢ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„
- `åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡`ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£ã€‚

`åŠ è½½ .classæ–‡ä»¶çš„æ–¹å¼`
- ä»æœ¬åœ°ç³»ç»Ÿä¸­ç›´æ¥åŠ è½½
- é€šè¿‡ç½‘ç»œè·å–ï¼Œå…¸å‹çš„åœºæ™¯ï¼šWeb Applet
- ä»zipå‹ç¼©åŒ…ä¸­è¯»å–ï¼Œæˆä¸ºæ—¥åjarã€waræ ¼å¼çš„åŸºç¡€
- è¿è¡Œæ—¶è®¡ç®—ç”Ÿæˆï¼Œä½¿ç”¨æœ€å¤šçš„åœºæ™¯æ˜¯ï¼šåŠ¨æ€ä»£ç†æŠ€æœ¯
- ç”±å…¶ä»–æ–‡ä»¶ç”Ÿæˆï¼Œå…¸å‹åœºæ™¯ï¼šJSPåº”ç”¨
- ä»ä¸“æœ‰æ•°æ®åº“ä¸­æå–.classæ–‡ä»¶ï¼Œæ¯”è¾ƒå°‘è§
- ä»åŠ å¯†æ–‡ä»¶ä¸­è·å–ï¼Œå…¸å‹çš„é˜²Classæ–‡ä»¶è¢«åç¼–è¯‘çš„ä¿æŠ¤æªæ–½
### 2ã€é“¾æ¥ï¼ˆLikingï¼‰

- `éªŒè¯ï¼ˆVerifyï¼‰ï¼š`
ç›®çš„åœ¨äºç¡®ä¿classæ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºçš„è¦æ±‚ï¼Œä¿è¯è¢«åŠ è½½çš„ç±»çš„æ­£ç¡®æ€§ï¼Œä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«å®‰å…¨ã€‚
ä¸»è¦åŒ…æ‹¬å››ç§éªŒè¯ï¼Œæ–‡ä»¶æ ¼å¼éªŒè¯ï¼Œå…ƒæ•°æ®éªŒè¯ï¼Œå­—èŠ‚ç éªŒè¯ï¼Œç¬¦å·å¼•ç”¨éªŒè¯ã€‚

- `å‡†å¤‡ï¼ˆprepareï¼‰ï¼š`
ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶ä¸”è®¾ç½®è¯¥ç±»å˜é‡çš„é»˜è®¤åˆå§‹å€¼ï¼Œå³é›¶å€¼ã€‚
**è¿™é‡Œä¸åŒ…å«ç”¨finalä¿®é¥°çš„staticï¼Œå› ä¸ºfinalåœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šåˆ†é…äº†ï¼Œå‡†å¤‡é˜¶æ®µä¼šæ˜¾ç¤ºåˆå§‹åŒ–ï¼›**
**è¿™é‡Œä¸ä¼šä¸ºå®ä¾‹å˜é‡åˆ†é…åˆå§‹åŒ–**ï¼Œç±»å˜é‡ä¼šåˆ†é…åœ¨æ–¹æ³•åŒºä¸­ï¼Œè€Œå®ä¾‹å˜é‡æ˜¯ä¼šéšç€å¯¹è±¡ä¸€èµ·åˆ†é…åˆ°Javaå †ä¸­ã€‚

- `è§£æï¼ˆResolveï¼‰ï¼š`
å°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚
äº‹å®ä¸Šï¼Œè§£ææ“ä½œå¾€å¾€ä¼šä¼´éšç€JVMåœ¨æ‰§è¡Œå®Œåˆå§‹åŒ–ä¹‹åå†æ‰§è¡Œã€‚
ç¬¦å·å¼•ç”¨å°±æ˜¯ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡ç¬¦å·å¼•ç”¨çš„å­—é¢é‡å½¢å¼æ˜ç¡®å®šä¹‰åœ¨ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹çš„classæ–‡ä»¶æ ¼å¼ä¸­ã€‚ç›´æ¥å¼•ç”¨å°±æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–ä¸€ä¸ªé—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚
è§£æåŠ¨ä½œä¸»è¦é’ˆå¯¹ç±»æˆ–æ¥å£ã€å­—æ®µã€ç±»æ–¹æ³•ã€æ¥å£æ–¹æ³•ã€æ–¹æ³•ç±»å‹ç­‰ã€‚å¯¹åº”å¸¸é‡æ± ä¸­çš„CONSTANT_Class_infoã€CONSTANT_Fieldref_infoã€CONSTANT_Methodref_infoç­‰ã€‚

### 3ã€åˆå§‹åŒ–ï¼ˆInitializationï¼‰

`åˆå§‹åŒ–é˜¶æ®µå°±æ˜¯æ‰§è¡Œç±»æ„é€ å™¨æ–¹æ³•<clinit>()çš„è¿‡ç¨‹ã€‚`
æ­¤æ–¹æ³•ä¸éœ€è¦å®šä¹‰ï¼Œæ˜¯javacç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­çš„æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€ä»£ç å—ä¸­çš„è¯­å¥åˆå¹¶è€Œæ¥ã€‚
```java
public class ClassInitTest {
    private static int num = 1;
    static {
        num = 2;
    }
    public static void main(String[] args) {
        System.out.println(ClassInitTest.num);
    }
}
```
![](https://snow-hh.github.io/assets/img/jvm/5-05.png)

æ„é€ å™¨æ–¹æ³•ä¸­æŒ‡ä»¤æŒ‰è¯­å¥åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„å¾ªåºæ‰§è¡Œã€‚

```java
public class ClassInitTest {
    private static int num = 1;
    static {
        num = 2;
        number = 20;
        System.out.println(num);
        //System.out.println(number);æŠ¥é”™ï¼šéæ³•çš„å‰å‘å¼•ç”¨
    }
    private static int number = 10;//likingä¹‹prepare : number =0 --> initialization 20 -->10
    public static void main(String[] args) {
        System.out.println(ClassInitTest.num);
        System.out.println(ClassInitTest.number);
    }
}
```

![](https://snow-hh.github.io/assets/img/jvm/5-06.png)

`<clinit>()ä¸åŒäºç±»çš„æ„é€ å™¨ã€‚`ï¼ˆå…³è”ï¼šæ„é€ å™¨æ˜¯è™šæ‹Ÿæœºè§†è§’ä¸‹çš„<init>()ï¼‰

```java
public class ClinitTest {
    //ä»»ä½•ä¸€ä¸ªç±»å£°æ˜ä»¥åï¼Œå†…éƒ¨è‡³å°‘å­˜åœ¨ä¸€ä¸ªç±»çš„æ„é€ å™¨
    private int a = 1;

    private static int c =3;

    public static void main(String[] args) {
        int b =2;
    }

    public ClinitTest(){
        a = 10;
        int d = 20;

    }
}
```

![](https://snow-hh.github.io/assets/img/jvm/5-07.png)

è‹¥è¯¥ç±»å…·æœ‰çˆ¶ç±»ï¼ŒJVMä¼šä¿è¯å­ç±»çš„<clinit>()æ‰§è¡Œå‰ï¼Œçˆ¶ç±»çš„<clinit>()å·²ç»æ‰§è¡Œå®Œæ¯•

```java
public class ClinitTest1 {

    static class Father{
        public static int A = 1;
        static {
            A = 2;
        }

    }
    static class Son extends Father{
        public static int B = A;
    }

    public static void main(String[] args) {
        //åŠ è½½Fatherç±»ï¼Œå…¶æ¬¡åŠ è½½Sonç±»
        System.out.println(Son.B);
    }

}
```

![](https://snow-hh.github.io/assets/img/jvm/5-08.png)

è™šæ‹Ÿæœºå¿…é¡»ä¿è¯ä¸€ä¸ªç±»çš„<clinit>()æ–¹æ³•åœ¨å¤šçº¿ç¨‹ä¸‹è¢«åŒæ­¥åŠ é”ã€‚

```java
public class DeadThreadTest {

    public static void main(String[] args) {
        Runnable r =() ->{
            System.out.println(Thread.currentThread().getName()+"å¼€å§‹");
            DeadThread dead = new DeadThread();
            System.out.println(Thread.currentThread().getName()+"ç»“æŸ");
        };
        Thread t1 = new Thread(r,"çº¿ç¨‹1");
        Thread t2 = new Thread(r,"çº¿ç¨‹2");

        t1.start();
        t2.start();
    }
}
class DeadThread{
    static {
        if (true){
            System.out.println(Thread.currentThread().getName()+"åˆå§‹åŒ–å½“å‰ç±»");
            while (true){

            }
        }
    }
}
```