# ç¬¬1èŠ‚ï¼šDocker

ä½œè€…ï¼šå°èƒ¡

>æ²‰æ·€ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## ä¸€ã€å‰è¨€

`ç³»ç»Ÿç‰ˆæœ¬ï¼šcentos 7ã€ubuntu 20.04`

`dockerç‰ˆæœ¬ï¼šv19.03.9ã€‚`[å®˜æ–¹ä¸‹è½½åœ°å€](https://download.docker.com/linux/static/stable/x86_64/)

`docker-composeç‰ˆæœ¬ï¼šv2.2.3ã€‚` [å®˜æ–¹ä¸‹è½½åœ°å€](https://github.com/docker/compose/releases/)

`å®˜æ–¹æ–‡æ¡£ï¼š`[å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/engine/reference/commandline/dockerd/)

å®˜æ–¹æä¾›å…å®‰è£…çš„äºŒè¿›åˆ¶ç¨‹åºåŒ…ï¼Œè§£å‹åå°±èƒ½ç”¨ã€‚

PS1: dockeråŸºäºiptablesåšè·¯ç”±è½¬å‘ï¼Œæ‰€ä»¥äº²æµ‹debian11ä¸Šéœ€è¦å…ˆå®‰è£…iptablesï¼ˆapt install -y iptablesï¼‰

## äºŒã€dockerå®‰è£…æ­¥éª¤

- **å®˜ç½‘ä¸‹è½½å®‰è£…åŒ…ã€‚**
- **è§£å‹å®‰è£…åŒ…ï¼Œå°†å®‰è£…åŒ…å†…çš„äºŒè¿›åˆ¶ç¨‹åºè§£å‹åˆ°`/usr/local/bin`ç›®å½•ã€‚**
- **å»ºç«‹`docker`çš„æ•°æ®å­˜æ”¾ç›®å½•ï¼š**
```shell
mkdir -p /home/data/docker
```
- **åˆ›å»ºdockerçš„serviceæ–‡ä»¶ï¼ˆ`/usr/lib/systemd/system/docker.service`ï¼‰ï¼š**
```shell
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network-online.target firewalld.service
Wants=network-online.target
[Service]
Type=notify
# the default is not to use systemd for cgroups because the delegate issues still
# exists and systemd currently does not support the cgroup feature set required
# for containers run by docker
ExecStart=/usr/local/bin/dockerd --data-root /home/data/docker
ExecReload=/bin/kill -s HUP $MAINPID
# Having non-zero Limit*s causes performance problems due to accounting overhead
# in the kernel. We recommend using cgroups to do container-local accounting.
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
# Uncomment TasksMax if your systemd version supports it.
# Only systemd 226 and above support this version.
#TasksMax=infinity
TimeoutStartSec=0
# set delegate yes so that systemd does not reset the cgroups of docker containers
Delegate=yes
# kill only the docker process, not all processes in the cgroup
KillMode=process
# restart the docker process if it exits prematurely
Restart=on-failure
StartLimitBurst=3
StartLimitInterval=60s
[Install]
WantedBy=multi-user.target
```
- **ä½¿é…ç½®ç”Ÿæ•ˆ**
```shell
# é‡æ–°åŠ è½½æ‰€æœ‰è¢«ä¿®æ”¹è¿‡çš„æœåŠ¡é…ç½®ï¼Œå¦åˆ™é…ç½®ä¸ä¼šç”Ÿæ•ˆ
systemctl daemon-reload
# å¼€å¯dockeræœåŠ¡
systemctl start docker
# å…³é—­dockeræœåŠ¡ systemctl stop docker æ­¤å¤„ä¸éœ€è¦æ‰§è¡Œ
# è®¾ç½®å¼€æœºå¯åŠ¨dockeræœåŠ¡
systemctl enable docker
# æŸ¥çœ‹dockeræœåŠ¡çš„çŠ¶æ€
systemctl status docker

```

- **éªŒè¯**
```shell
docker info
```

## ä¸‰ã€docker-composeå®‰è£…æ­¥éª¤
- **å®˜ç½‘ä¸‹è½½äºŒè¿›åˆ¶ç¨‹åºåŒ…**
- **é‡å‘½åä¸º`docker-compose`ï¼Œå¹¶ç§»åˆ°`/usr/local/bin`**
- **éªŒè¯**
```shell
docker-compose --version
```

## å››ã€é…ç½®dockerçš„daemon.json

- æ£€æŸ¥æ ¼å¼

```shell
vim /etc/docker/daemon.json
cat /etc/docker/daemon.json | python -m json.tool
```
```json
{
    "exec-opts": [
        "native.cgroupdriver=systemd"
    ],
    "log-driver": "json-file",
    "log-level": "warn",
    "log-opts": {
        "max-size": "100m"
    },
    "storage-driver": "overlay2",
    "storage-opts": [
        "overlay2.override_kernel_check=true"
    ],
    "registry-mirrors": [
        "https://sral7lkb.mirror.aliyuncs.com"
    ],
    "ip-forward": true,
    "ip-masq": false,
    "iptables": false,
    "ipv6": false,
    "live-restore": true,
    "selinux-enabled": false,
    "bip": "172.17.200.1/24",
    "data-root": "/home/data/docker"
}
```

å®˜æ–¹å®Œå…¨ç¤ºä¾‹
```json
{
  "allow-nondistributable-artifacts": [],
  "api-cors-header": "",
  "authorization-plugins": [],
  "bip": "",
  "bridge": "",
  "cgroup-parent": "",
  "containerd": "/run/containerd/containerd.sock",
  "containerd-namespace": "docker",
  "containerd-plugin-namespace": "docker-plugins",
  "data-root": "",
  "debug": true,
  "default-address-pools": [
    {
      "base": "172.30.0.0/16",
      "size": 24
    },
    {
      "base": "172.31.0.0/16",
      "size": 24
    }
  ],
  "default-cgroupns-mode": "private",
  "default-gateway": "",
  "default-gateway-v6": "",
  "default-runtime": "runc",
  "default-shm-size": "64M",
  "default-ulimits": {
    "nofile": {
      "Hard": 64000,
      "Name": "nofile",
      "Soft": 64000
    }
  },
  "dns": [],
  "dns-opts": [],
  "dns-search": [],
  "exec-opts": [],
  "exec-root": "",
  "experimental": false,
  "features": {},
  "fixed-cidr": "",
  "fixed-cidr-v6": "",
  "group": "",
  "hosts": [],
  "proxies": {
    "http-proxy": "http://proxy.example.com:80",
    "https-proxy": "https://proxy.example.com:443",
    "no-proxy": "*.test.example.com,.example.org"
  },
  "icc": false,
  "init": false,
  "init-path": "/usr/libexec/docker-init",
  "insecure-registries": [],
  "ip": "0.0.0.0",
  "ip-forward": false,
  "ip-masq": false,
  "iptables": false,
  "ip6tables": false,
  "ipv6": false,
  "labels": [],
  "live-restore": true,
  "log-driver": "json-file",
  "log-level": "",
  "log-opts": {
    "cache-disabled": "false",
    "cache-max-file": "5",
    "cache-max-size": "20m",
    "cache-compress": "true",
    "env": "os,customer",
    "labels": "somelabel",
    "max-file": "5",
    "max-size": "10m"
  },
  "max-concurrent-downloads": 3,
  "max-concurrent-uploads": 5,
  "max-download-attempts": 5,
  "mtu": 0,
  "no-new-privileges": false,
  "node-generic-resources": [
    "NVIDIA-GPU=UUID1",
    "NVIDIA-GPU=UUID2"
  ],
  "oom-score-adjust": 0,
  "pidfile": "",
  "raw-logs": false,
  "registry-mirrors": [],
  "runtimes": {
    "cc-runtime": {
      "path": "/usr/bin/cc-runtime"
    },
    "custom": {
      "path": "/usr/local/bin/my-runc-replacement",
      "runtimeArgs": [
        "--debug"
      ]
    }
  },
  "seccomp-profile": "",
  "selinux-enabled": false,
  "shutdown-timeout": 15,
  "storage-driver": "",
  "storage-opts": [],
  "swarm-default-advertise-addr": "",
  "tls": true,
  "tlscacert": "",
  "tlscert": "",
  "tlskey": "",
  "tlsverify": true,
  "userland-proxy": false,
  "userland-proxy-path": "/usr/libexec/docker-proxy",
  "userns-remap": ""
}
```

## äº”ã€è¡¥å……
&emsp;&emsp;æ™®é€šç”¨æˆ·å¦‚éœ€ä½¿ç”¨äºŒè¿›åˆ¶æ–¹å¼å®‰è£…çš„dockerï¼Œå¯å‚è€ƒä»¥ä¸‹æ­¥éª¤ã€‚å‡è®¾æ™®é€šç”¨æˆ·çš„ç”¨æˆ·åä¸ºadmin
```shell
# 1. åˆ›å»ºdockerç”¨æˆ·ç»„
groupadd docker
# 2. å°†adminç”¨æˆ·åŠ åˆ°dockerç”¨æˆ·ç»„
usermod admin -a -G docker
# 3. é‡å¯docker
systemctl restart docker
# 4. adminç”¨æˆ·æ‰§è¡Œdockerå‘½ä»¤è¿›è¡Œæµ‹è¯•
```

## å…­ã€åº”ç”¨
- å¸¸è§å‘½ä»¤

```shell
# æŸ¥çœ‹æœ¬åœ°ä¸»æœºä¸Šæ‰€æœ‰é•œåƒ
docker images
# æœç´¢é•œåƒ
docker search mysql
# æ‹‰å–é•œåƒ
docker pull mysql
# åˆ é™¤é•œåƒ ï¼ˆå¦‚åˆ é™¤ä»æŠ¥é”™ï¼Œéœ€è¦æŸ¥çœ‹æ˜¯å¦æœ‰containerå®¹å™¨å®ä¾‹å­˜åœ¨å³é€šè¿‡docker ps -aæŸ¥çœ‹ï¼Œå­˜åœ¨éœ€è¦å…ˆåˆ é™¤containerå®ä¾‹ï¼‰
docker rmi nginx
# åˆ é™¤å®¹å™¨å®ä¾‹ å¤šä¸ªç”¨ç©ºæ ¼åˆ†å¼€
docker rm å®¹å™¨åç§°/ID
# æ˜¾ç¤ºæ­£åœ¨è¿è¡Œçš„å®¹å™¨
docker ps
# æ˜¾ç¤ºæ‰€æœ‰å®¹å™¨
docker ps -a
# ç”¨äºåˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªæ–°çš„å®¹å™¨å®ä¾‹ã€‚ é€šå¸¸ç”¨äºé¦–æ¬¡å¯åŠ¨å®¹å™¨ã€‚
# -i:ä»¥äº¤äº’æ¨¡å¼è¿è¡Œå®¹å™¨ï¼Œé€šå¸¸äº-tä¸€èµ·ä½¿ç”¨
# -t:ä¸ºå®¹å™¨é‡æ–°åˆ†é…ä¸€ä¸ªä¼ªè¾“å…¥ç»ˆç«¯ï¼Œé€šå¸¸äº-iä¸€èµ·ä½¿ç”¨
# -d: åå°è¿è¡Œå®¹å™¨ï¼Œå¹¶è¿”å›å®¹å™¨IDï¼›
# -P: éšæœºç«¯å£æ˜ å°„ï¼Œå®¹å™¨å†…éƒ¨ç«¯å£éšæœºæ˜ å°„åˆ°ä¸»æœºçš„ç«¯å£
# -p: æŒ‡å®šç«¯å£æ˜ å°„ï¼Œæ ¼å¼ä¸ºï¼šä¸»æœº(å®¿ä¸»)ç«¯å£:å®¹å™¨ç«¯å£
# --name=â€œå®¹å™¨æ–°åå­—â€ å–åˆ«å
docker run -it -p 8888:8080 tomcat
docker run -it --name åˆ«å -d -p 8888:8080 é•œåƒID
# å¯åŠ¨å®¹å™¨ å¯åŠ¨å·²ç»å­˜åœ¨ä½†å¤„äºåœæ­¢çŠ¶æ€çš„å®¹å™¨ã€‚
docker start å®¹å™¨åç§°/ID
# é‡å¯å®¹å™¨
docker restart å®¹å™¨åç§°/ID
# åœæ­¢å®¹å™¨
docker stop å®¹å™¨åç§°/ID
# æ€æ­»è¿›ç¨‹
docker kill å®¹å™¨åç§°/ID
# è¿›å…¥å®¹å™¨  å®¹å™¨åç§°/IDä¸ºéœ€è¦è¿›å…¥çš„å®¹å™¨çš„åç§°æˆ–IDã€‚ /bin/bash ä¹Ÿå¯ç”¨bashä»£æ›¿ã€‚åŸºäºUbuntuçš„é•œåƒé€šå¸¸ä½¿ç”¨ /bin/bash ä½œä¸ºé»˜è®¤shellï¼Œè€ŒåŸºäºAlpineçš„é•œåƒé€šå¸¸ä½¿ç”¨ /bin/sh ä½œä¸ºé»˜è®¤shell
docker exec -it å®¹å™¨åç§°/ID /bin/bash
docker exec -it å®¹å™¨åç§°/ID bash
docker exec -it jdk sh
docker exec -it jdk /bin/sh
# é€€å‡ºå®¹å™¨
exit
# æŸ¥çœ‹å®¹å™¨å¯åŠ¨çš„æ—¥å¿— -f æ§åˆ¶å°å®æ—¶è¾“å‡ºæ—¥å¿—
docker logs -f å®¹å™¨åç§°/ID
# å¿«é€Ÿåœ°å¯åŠ¨å’Œåœæ­¢å®¹å™¨ã€‚ç”±äºå®¹å™¨æ˜¯è½»é‡çº§çš„ï¼Œå¯åŠ¨é€Ÿåº¦éå¸¸å¿«ï¼Œå¯ä»¥åœ¨å‡ ç§’é’Ÿå†…å¯åŠ¨ä¸€ä¸ªæ–°çš„å®¹å™¨ã€‚è€Œå½“å®¹å™¨ä¸å†ä½¿ç”¨æ—¶ï¼Œ--rmå‚æ•°ä¹Ÿèƒ½å¤Ÿå¿«é€Ÿåœ°æ¸…é™¤è¯¥å®¹å™¨ï¼Œé¿å…åƒåœ¾å †ç§¯ã€‚
docker run -it --rm ubuntu /bin/bash
docker run -it --rm jdk /bin/sh
# å¯¼å‡ºé•œåƒ ä¸¤è€…æ²¡åŒºåˆ«
docker save -o image.tar image_name/ID
docker save > image.tar image_name/ID
# å¯¼å…¥é•œåƒ ä¸¤è€…æ²¡åŒºåˆ«
docker load < image.tar
docker load -i image.tar
# å¯¼å‡ºå®¹å™¨ å¯¼å‡ºå®¹å™¨æ˜¯å°†ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ Docker å®¹å™¨ä¿å­˜ä¸ºä¸€ä¸ªå‹ç¼©æ–‡ä»¶ã€‚å¯¼å‡ºçš„å®¹å™¨æ–‡ä»¶åŒ…å«äº†å®¹å™¨å½“å‰çš„æ–‡ä»¶ç³»ç»Ÿå¿«ç…§ï¼Œä»¥åŠå®¹å™¨çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚å¯¼å‡ºå®¹å™¨å¯ä»¥ç”¨äºå¤‡ä»½å®¹å™¨çš„çŠ¶æ€ï¼Œæˆ–è€…å°†å®¹å™¨è¿ç§»åˆ°å…¶ä»–ç¯å¢ƒä¸­ç»§ç»­è¿è¡Œã€‚
# éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¼å‡ºå®¹å™¨åªä¿å­˜å®¹å™¨çš„å½“å‰çŠ¶æ€å’Œæ–‡ä»¶ç³»ç»Ÿå¿«ç…§ï¼Œå¹¶ä¸åŒ…å«å®¹å™¨çš„é•œåƒæ„å»ºä¿¡æ¯ã€‚å› æ­¤ï¼Œåœ¨å¯¼å…¥å¯¼å‡ºçš„å®¹å™¨æ–‡ä»¶æ—¶ï¼Œéœ€è¦ç¡®ä¿ç›®æ ‡ç¯å¢ƒä¸­å·²ç»å­˜åœ¨ç›¸åº”çš„é•œåƒã€‚
docker export f5332ebce695 > container.tar
# å¯¼å…¥å®¹å™¨
docker import container.tar openjdk:17-jdk-alpine
```

- Dockerfile æ–‡ä»¶

```shell
FROM registry.cn-shanghai.aliyuncs.com/aliux/openjdk:17-jdk-alpine
MAINTAINER 1129447124@qq.com
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories
## æ›´æ–°apkæº
RUN apk update
## è®¾ç½®æ—¶åŒº
RUN apk add -U tzdata
RUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

# åˆ›å»ºæ–‡ä»¶
RUN apk --update add curl bash ttf-dejavu && rm -rf /var/cache/apk/*

## è®¾ç½®è¾“å‡ºæ ¼å¼
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US:en
ENV LC_ALL en_US.UTF-8

WORKDIR /usr/app
ADD ./target ./
CMD [ "/bin/sh", "-c", "java -Dloader.path=./lib -Ddruid.mysql.usePingMethod=false -jar -Xms1024M -Xmx1024M app.jar" ]
```



